<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.45.4';

  // ─── ТВОИ РЕАЛЬНЫЕ ЗНАЧЕНИЯ ────────────────────────────────────────────
  const supabaseUrl   = 'https://ВАШ-ПРОЕКТ.supabase.co';
  const supabaseKey   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'; // anon public key
  const stripePriceId = 'price_1xxxxxxxxxxxxxx';
  // ────────────────────────────────────────────────────────────────────────

  const supabase = createClient(supabaseUrl, supabaseKey);

  const elements = {
    modal: document.getElementById('modal'),
    authModal: document.getElementById('auth-modal'),
    mainBtn: document.getElementById('mainBtn'),
    refreshBtn: document.getElementById('refreshBtn'),
    subscribeBtn: document.getElementById('subscribe-btn'),
    logoutBtn: document.getElementById('logout-btn'),
    closeBtn: document.getElementById('closeBtn'),
    authClose: document.getElementById('auth-close'),
    loader: document.getElementById('loader'),
    error: document.getElementById('error'),
    category: document.getElementById('category'),
    title: document.getElementById('title'),
    photo: document.getElementById('photo'),
    ingredients: document.getElementById('ingredients'),
    steps: document.getElementById('steps'),
    time: document.getElementById('time'),
    calories: document.getElementById('calories'),
    note: document.getElementById('note'),
    welcomeModal: document.getElementById('welcome-modal'),
    welcomeClose: document.getElementById('welcome-close'),
    emailInput: document.getElementById('email'),
    passwordInput: document.getElementById('password'),
    signupBtn: document.getElementById('signup-btn'),
    signinBtn: document.getElementById('signin-btn')
  };

  let loadedRecipes = {};
  let currentCategory = null;
  let recipeIndices = {};
  let allPhotos = new Set();
  const categoryNames = {
    breakfast: "Завтрак", lunch: "Обед", dinner: "Ужин", soups: "Супы", dessert: "Десерт"
  };
  const fallbackImage = 'data:image/svg+xml;utf8,<svg width="400" height="200" viewBox="0 0 400 200" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="200" fill="%23f8f1e9"/><text x="50%" y="45%" font-family="Inter" font-size="16" fill="%23997" text-anchor="middle">Фото блюда</text><text x="50%" y="60%" font-family="Inter" font-size="13" fill="%23aaa" text-anchor="middle">(не найдено)</text></svg>';

  // ─── АУТЕНТИФИКАЦИЯ ─────────────────────────────────────────────────────
  async function signUp() {
    let email = elements.emailInput.value.trim();
    let password = elements.passwordInput.value.trim();

    // Очистка: убираем пробелы, табы, не-ASCII (очень строго для теста)
    email = email.replace(/[^a-zA-Z0-9@._-]/g, '');
    password = password.replace(/[^a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/g, '');

    console.log('Попытка регистрации:', { email, passwordLength: password.length });

    if (!email.includes('@') || password.length < 6) {
      elements.error.textContent = "Некорректный email или пароль короче 6 символов";
      elements.error.style.display = 'block';
      return;
    }

    try {
      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        // options: { emailRedirectTo: window.location.origin }  // Временно отключено — часто причина ошибки
      });

      if (error) throw error;

      alert("Письмо отправлено! Проверьте почту (включая папку Спам).");
      closeAuthModal();
      await updateUIState();
    } catch (err) {
      console.error('Ошибка signUp:', err);
      elements.error.textContent = err.message || "Ошибка регистрации. Попробуйте другой email/пароль.";
      elements.error.style.display = 'block';
    }
  }

  async function signIn() {
    let email = elements.emailInput.value.trim();
    let password = elements.passwordInput.value.trim();

    email = email.replace(/[^a-zA-Z0-9@._-]/g, '');
    password = password.replace(/[^a-zA-Z0-9!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/g, '');

    console.log('Попытка входа:', { email });

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (error) throw error;

      closeAuthModal();
      await updateUIState();
    } catch (err) {
      console.error('Ошибка signIn:', err);
      elements.error.textContent = err.message || "Неверный email или пароль";
      elements.error.style.display = 'block';
    }
  }

  async function logout() {
    await supabase.auth.signOut();
    await updateUIState();
  }

  async function getUserAndSubscription() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return { user: null, profile: null };

    const { data: profile } = await supabase
      .from('profiles')
      .select('is_subscribed')
      .eq('id', user.id)
      .single();

    return { user, profile };
  }

  async function updateUIState() {
    const { user, profile } = await getUserAndSubscription();

    elements.mainBtn.style.display = 'block';

    if (!user) {
      elements.subscribeBtn.style.display = 'none';
      elements.logoutBtn.style.display = 'none';
      elements.mainBtn.disabled = false;
      elements.mainBtn.textContent = "Случайный рецепт (войти)";
      return;
    }

    elements.logoutBtn.style.display = 'block';

    if (profile?.is_subscribed) {
      elements.subscribeBtn.style.display = 'none';
      elements.mainBtn.disabled = false;
      elements.mainBtn.textContent = "Случайный рецепт";
    } else {
      elements.subscribeBtn.style.display = 'block';
      elements.mainBtn.disabled = true;
      elements.mainBtn.textContent = "Случайный рецепт (подписка)";
    }
  }

  async function createCheckoutSession() {
    const { user } = await supabase.auth.getUser();
    if (!user) return alert("Сначала войдите");

    try {
      const res = await fetch('/.netlify/functions/create-checkout', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ priceId: stripePriceId, clientReferenceId: user.id })
      });
      const data = await res.json();
      if (data.error) throw new Error(data.error);
      window.location.href = data.url;
    } catch (err) {
      alert("Ошибка платежа: " + err.message);
    }
  }

  // ─── МОДАЛКИ ────────────────────────────────────────────────────────────
  function openAuthModal() { elements.authModal.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
  function closeAuthModal() { elements.authModal.style.display = 'none'; document.body.style.overflow = 'auto'; }
  function openModal() { elements.modal.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
  function closeModal() { elements.modal.style.display = 'none'; document.body.style.overflow = 'auto'; }

  // ─── ОСТАЛЬНОЕ (loadCategoryRecipes, generateRecipe, updateUI и т.д.) ───
  // Вставь сюда свои оригинальные функции loadCategoryRecipes, preloadAllImages, selectCategory, generateRecipe, updateUI
  // Они не менялись, поэтому опускаю для краткости

  document.addEventListener('DOMContentLoaded', async () => {
    await updateUIState();
    // showWelcomeIfFirstTime(); и остальные обработчики событий — как было раньше
    elements.signupBtn.onclick = signUp;
    elements.signinBtn.onclick = signIn;
    elements.authClose.onclick = () => { closeAuthModal(); updateUIState(); };
    // ... остальные onclick
  });
</script>
