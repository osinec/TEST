<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–µ—Ü–µ–ø—Ç–æ–≤</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pocketbase/0.21.1/pocketbase.umd.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      color: #222;
      padding: 30px;
    }
    .card {
      width: 100%;
      max-width: 540px;
      background: rgba(255,255,255,.96);
      border-radius: 26px;
      padding: 32px 28px;
      text-align: center;
      box-shadow: 0 30px 70px rgba(0,0,0,.18);
      margin: 0 auto;
    }
    button {
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      border: none;
      border-radius: 40px;
      font-weight: 600;
      transition: all .3s;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }
    .main-btn {
      padding: 20px 35px;
      background: linear-gradient(135deg,#f6d365,#fda085);
      font-size: 18px;
      color: #222;
      width: 100%;
      margin: 0 0 20px 0;
    }
    .main-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .premium-btn {
      background: linear-gradient(135deg, #84fab0, #8fd3f4);
      color: #222;
      padding-right: 60px;
      width: 100%;
      margin-bottom: 20px;
    }
    .premium-badge {
      position: absolute;
      top: 50%;
      right: 18px;
      transform: translateY(-50%);
      font-size: 24px;
      color: #ffcc00;
      pointer-events: none;
      line-height: 1;
    }
    .refresh {
      display: none;
      margin-top: 15px;
      padding: 18px 30px;
      background: linear-gradient(135deg,#ff6a00,#ee0979);
      color: #fff;
      font-size: 17px;
      width: 100%;
    }
    .category {
      margin-top: 25px;
      font-size: 15px;
      letter-spacing: 2px;
      font-weight: 600;
      color: #c7903d;
      text-transform: uppercase;
    }
    h2 { margin: 15px 0 20px; font-size: 24px; font-weight: 700; }
    #photo {
      width: 100%; height: 260px; object-fit: cover; border-radius: 16px;
      display: none; margin-bottom: 20px; background: #f8f1e9;
    }
    .section-title { text-align: left; font-size: 17px; font-weight: 600; margin: 24px 0 12px; }
    .plain-list { text-align: left; font-size: 16px; line-height: 1.65; white-space: pre-wrap; }
    .modal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px); justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-box { background: #fff; padding: 32px 28px; border-radius: 22px; width: 90%; max-width: 380px; position: relative; }
    .close { position: absolute; top: 12px; right: 14px; font-size: 26px; cursor: pointer; }
    .choice { width: 100%; margin-top: 12px; padding: 15px; background: #f8f9fa; border-radius: 12px; text-align: left; }
    .loader { display: none; padding: 20px; }
    .error { color: red; display: none; margin-top: 10px; }
    #welcome-modal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,.6);
      justify-content: center; align-items: center; z-index: 1100;
    }
    #welcome-box { background: #fff; padding: 25px; border-radius: 20px; max-width: 320px; text-align: center; }
  </style>
</head>
<body>

<div class="card">
  <button class="main-btn" id="mainBtn">–°–ª—É—á–∞–π–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç</button>
  
  <button class="premium-btn" id="menuBtn" onclick="window.location.href='menu.html'">
    –ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é <span class="premium-badge">üëë</span>
  </button>
  
  <button class="premium-btn" id="ingredientsBtn" onclick="window.location.href='ingredients.html'">
    –ü–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞–º <span class="premium-badge">üëë</span>
  </button>

  <button class="refresh" id="refreshBtn">–ï—â–µ –æ–¥–∏–Ω —Ä–µ—Ü–µ–ø—Ç üîÑ</button>
  
  <div class="loader" id="loader">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div class="error" id="error"></div>
  
  <div class="category" id="category"></div>
  <h2 id="title">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
  <img id="photo" alt="–§–æ—Ç–æ">
  <div id="ingredients"></div>
  <div id="steps"></div>
  <div id="time"></div>
  <div id="calories"></div>
  <div id="note"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <div class="close" id="closeBtn">‚úï</div>
    <h3>–ß—Ç–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏–º?</h3>
    <button class="choice" data-category="breakfast">–ó–∞–≤—Ç—Ä–∞–∫</button>
    <button class="choice" data-category="lunch">–û–±–µ–¥</button>
    <button class="choice" data-category="dinner">–£–∂–∏–Ω</button>
    <button class="choice" data-category="soups">–°—É–ø—ã</button>
    <button class="choice" data-category="dessert">–î–µ—Å–µ—Ä—Ç</button>
  </div>
</div>

<div id="welcome-modal">
  <div id="welcome-box">
    <div id="welcome-text">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –í—ã–±–∏—Ä–∞–π—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç.</div>
    <button class="main-btn" style="margin-top:15px" id="welcome-close">–ü–æ–Ω—è—Ç–Ω–æ</button>
  </div>
</div>

<script>
const pb = new PocketBase('http://217.12.37.52:8090');

const elements = {
  modal: document.getElementById('modal'),
  mainBtn: document.getElementById('mainBtn'),
  refreshBtn: document.getElementById('refreshBtn'),
  closeBtn: document.getElementById('closeBtn'),
  loader: document.getElementById('loader'),
  error: document.getElementById('error'),
  category: document.getElementById('category'),
  title: document.getElementById('title'),
  photo: document.getElementById('photo'),
  ingredients: document.getElementById('ingredients'),
  steps: document.getElementById('steps'),
  time: document.getElementById('time'),
  calories: document.getElementById('calories'),
  note: document.getElementById('note'),
  welcomeModal: document.getElementById('welcome-modal'),
  welcomeClose: document.getElementById('welcome-close'),
  menuBtn: document.getElementById('menuBtn'),
  ingredientsBtn: document.getElementById('ingredientsBtn')
};

let loadedRecipes = {};
let currentCategory = null;

const categoryNames = {
  breakfast: "–ó–∞–≤—Ç—Ä–∞–∫", lunch: "–û–±–µ–¥", dinner: "–£–∂–∏–Ω", soups: "–°—É–ø—ã", dessert: "–î–µ—Å–µ—Ä—Ç"
};

const fallbackImage = 'https://via.placeholder.com/400x260?text=–ù–µ—Ç+—Ñ–æ—Ç–æ';

// 1. –ü–æ–∫–∞–∑ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
if (!localStorage.getItem('hasSeenWelcome')) {
  elements.welcomeModal.style.display = 'flex';
}
elements.welcomeClose.onclick = () => {
  elements.welcomeModal.style.display = 'none';
  localStorage.setItem('hasSeenWelcome', 'true');
};

// 2. –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
elements.mainBtn.onclick = () => elements.modal.style.display = 'flex';
elements.closeBtn.onclick = () => elements.modal.style.display = 'none';

document.querySelectorAll('.choice').forEach(btn => {
  btn.onclick = () => {
    currentCategory = btn.dataset.category;
    elements.modal.style.display = 'none';
    generateRecipe();
  };
});

// 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –∏–∑ JSON —Ñ–∞–π–ª–æ–≤
async function generateRecipe() {
  elements.error.style.display = 'none';
  elements.loader.style.display = 'block';

  try {
    if (!loadedRecipes[currentCategory]) {
      const resp = await fetch(`recipes/${currentCategory}.json`);
      if (!resp.ok) throw new Error("–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω");
      loadedRecipes[currentCategory] = await resp.json();
    }

    const recipes = loadedRecipes[currentCategory];
    const randomRecipe = recipes[Math.floor(Math.random() * recipes.length)];
    
    updateUI(randomRecipe);
  } catch (err) {
    elements.error.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤";
    elements.error.style.display = 'block';
  } finally {
    elements.loader.style.display = 'none';
  }
}

// 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
function updateUI(r) {
  elements.title.textContent = r.title;
  elements.category.textContent = categoryNames[currentCategory];
  
  elements.photo.style.display = 'block';
  if (r.photo) {
    const filename = r.photo.split('/').pop().replace(/\.[^/.]+$/, "");
    elements.photo.src = `pics/${filename}.webp`;
  } else {
    elements.photo.src = fallbackImage;
  }

  elements.ingredients.innerHTML = `<div class="section-title">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</div><div class="plain-list">${r.ingredients.join('<br>')}</div>`;
  elements.steps.innerHTML = `<div class="section-title">–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</div><div class="plain-list">${r.steps.map((s, i) => (i+1)+'. '+s).join('<br>')}</div>`;
  elements.time.innerHTML = `<strong>–í—Ä–µ–º—è:</strong> ${r.time || '‚Äî'}`;
  elements.calories.innerHTML = `<strong>–ö–∞–ª–æ—Ä–∏–∏:</strong> ${r.calories || '‚Äî'}`;
  
  elements.refreshBtn.style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

elements.refreshBtn.onclick = generateRecipe;

// 5. –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ (–±–µ–∑ –≤—ã–ª–µ—Ç–æ–≤)
async function checkAuth() {
  // –ï—Å–ª–∏ –Ω–µ—Ç –∫–Ω–æ–ø–æ–∫ –ª–æ–≥–∏–Ω–∞ –≤ HTML, –ø—Ä–æ—Å—Ç–æ –ø–æ–¥–∞–≤–ª—è–µ–º –æ—à–∏–±–∫–∏
  try {
    if (pb.authStore.isValid) {
      const user = pb.authStore.model;
      if (user.is_subscribed) {
        // –£–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫–∏ –∫–æ—Ä–æ–Ω, –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω
        document.querySelectorAll('.premium-badge').forEach(b => b.style.display = 'none');
      }
    }
  } catch (e) {
    console.log("Auth check skipped");
  }
}

checkAuth();
</script>

</body>
</html>
