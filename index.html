<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–µ—Ü–µ–ø—Ç–æ–≤</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      color: #222;
      padding: 30px;
    }
    .card {
      width: 100%;
      max-width: 540px;
      background: rgba(255,255,255,.96);
      border-radius: 26px;
      padding: 32px 28px;
      text-align: center;
      box-shadow: 0 30px 70px rgba(0,0,0,.18);
      margin: 0 auto;
    }
    button {
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      border: none;
      border-radius: 40px;
      font-weight: 600;
      transition: all .3s;
      -webkit-tap-highlight-color: transparent;
    }
    .main-btn {
      padding: 20px 35px;
      background: linear-gradient(135deg,#f6d365,#fda085);
      font-size: 18px;
      color: #222;
      width: 100%;
      margin: 0 0 20px 0;
    }
    .main-btn:last-child {
      margin-bottom: 0;
    }
    .main-btn:hover, .main-btn:active {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,.15);
    }
    .refresh {
      display: none;
      margin-top: 15px;
      padding: 18px 30px;
      background: linear-gradient(135deg,#ff6a00,#ee0979);
      color: #fff;
      font-size: 17px;
      width: 100%;
    }
    .refresh:hover, .refresh:active {
      transform: translateY(-2px);
      box-shadow: 0 8px 15px rgba(238,9,121,.3);
    }
    .category {
      margin-top: 25px;
      font-size: 15px;
      letter-spacing: 2px;
      font-weight: 600;
      color: #c7903d;
      text-transform: uppercase;
    }
    h2 {
      margin: 15px 0 20px;
      font-size: 24px;
      font-weight: 700;
      line-height: 1.3;
    }
    #photo {
      width: 100%;
      height: 260px;
      object-fit: cover;
      border-radius: 16px;
      display: none;
      margin: 12px 0 20px;
      max-height: 35vh;
      background: #f8f1e9 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23e0d0c0"/><text x="50%" y="50%" font-family="Inter" font-size="12" fill="%23997" text-anchor="middle" dy=".3em">–§–æ—Ç–æ –±–ª—é–¥–∞</text></svg>') center/cover no-repeat;
      transition: opacity 0.3s ease;
    }
    #photo.loaded { opacity: 1; }
    .section-title {
      text-align: left;
      font-size: 17px;
      font-weight: 600;
      color: #333;
      margin: 24px 0 12px;
    }
    .plain-list {
      text-align: left;
      font-size: 16px;
      line-height: 1.65;
      color: #333;
      margin: 0 0 24px 0;
      white-space: pre-wrap;
    }
    .note {
      text-align: left;
      margin-top: 20px;
      font-size: 15.5px;
      color: #555;
      font-style: italic;
      padding: 14px 16px;
      background: #fdfaf7;
      border-left: 4px solid #f4a261;
      border-radius: 8px;
      line-height: 1.6;
    }
    .note strong { color: #d35400; font-style: normal; }
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal-box {
      background: #fff;
      padding: 32px 28px;
      border-radius: 22px;
      width: 100%;
      max-width: 380px;
      position: relative;
      animation: modalAppear 0.3s ease;
    }
    @keyframes modalAppear {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .close {
      position: absolute;
      top: 12px; right: 14px;
      font-size: 26px;
      cursor: pointer;
      opacity: .6;
      transition: opacity 0.2s;
      width: 36px; height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .close:hover { opacity: 1; }
    .choice {
      width: 100%;
      margin-top: 18px;
      padding: 20px 15px;
      background: #f8f9fa;
      font-size: 17px;
      border-radius: 16px;
      transition: all 0.28s ease;
      text-align: left;
      border: 1px solid #eee;
    }
    .choice:hover {
      background: #f0f4f8;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .loader { display: none; text-align: center; padding: 30px; color: #666; font-size: 16px; }
    .error {
      color: #d32f2f;
      background: #ffebee;
      padding: 12px 16px;
      border-radius: 10px;
      margin-top: 12px;
      font-size: 15px;
      display: none;
    }
    #welcome-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.6);
      backdrop-filter: blur(5px);
      justify-content: center;
      align-items: center;
      z-index: 1100;
      padding: 20px;
    }
    #welcome-box {
      background: #ffffff;
      padding: 28px 24px;
      border-radius: 20px;
      width: 100%;
      max-width: 400px;
      position: relative;
      box-shadow: 0 20px 50px rgba(0,0,0,.25);
    }
    #welcome-text {
      font-size: 16px;
      line-height: 1.55;
      color: #333;
      margin-bottom: 20px;
    }
    #welcome-close {
      position: absolute;
      top: 12px;
      right: 16px;
      font-size: 28px;
      cursor: pointer;
      color: #777;
    }
    #welcome-close:hover {
      color: #222;
    }
    @media (max-width:360px) {
      .card { padding: 24px 18px; border-radius: 20px; }
      h2 { font-size: 22px; }
      #photo { height: 180px; }
    }
    @media (min-width:768px) {
      body { align-items: center; padding: 50px 30px; }
      .card { padding: 40px; }
    }
    /* –î–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ */
    #auth-modal {
      display: none;
    }
    #auth-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    #subscribe-btn {
      background: linear-gradient(135deg, #4caf50, #66bb6a);
      display: none;
    }
    #logout-btn {
      background: linear-gradient(135deg, #f44336, #ef5350);
      display: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>
<div class="card">
  <button class="main-btn" id="mainBtn">–°–ª—É—á–∞–π–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç</button>
  <button class="main-btn" onclick="window.location.href='menu.html'" style="background: linear-gradient(135deg, #a1c4fd, #c2e9fb);">
    –ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é ‚Üí
  </button>
  <button class="main-btn" id="subscribe-btn">–û—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
  <button class="main-btn" id="logout-btn">–í—ã–π—Ç–∏</button>
  <button class="refresh" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç üîÑ</button>
  <div class="loader" id="loader">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤...</div>
  <div class="error" id="error"></div>
  <div class="category" id="category"></div>
  <h2 id="title">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
  <img id="photo" alt="–§–æ—Ç–æ —Ä–µ—Ü–µ–ø—Ç–∞" loading="lazy" decoding="async">
  <div id="ingredients"></div>
  <div id="steps"></div>
  <div id="time"></div>
  <div id="calories"></div>
  <div id="note"></div>
</div>
<div class="modal" id="modal">
  <div class="modal-box">
    <div class="close" id="closeBtn">‚úï</div>
    <h3 style="margin-bottom:22px;font-size:22px">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h3>
    <button class="choice" data-category="breakfast">–ó–∞–≤—Ç—Ä–∞–∫</button>
    <button class="choice" data-category="lunch">–û–±–µ–¥</button>
    <button class="choice" data-category="dinner">–£–∂–∏–Ω</button>
    <button class="choice" data-category="soups">–°—É–ø—ã</button>
    <button class="choice" data-category="dessert">–î–µ—Å–µ—Ä—Ç</button>
  </div>
</div>
<div class="modal" id="auth-modal">
  <div class="modal-box">
    <div class="close" id="auth-close">‚úï</div>
    <h3 style="margin-bottom:22px;font-size:22px">–í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
    <form id="auth-form">
      <input type="email" id="email" placeholder="Email" required>
      <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" required>
      <button class="main-btn" type="button" id="signup-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      <button class="main-btn" type="button" id="signin-btn">–í—Ö–æ–¥</button>
    </form>
  </div>
</div>
<div id="welcome-modal">
  <div id="welcome-box">
    <div id="welcome-close">‚úï</div>
    <div id="welcome-text">
      –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≤—Å–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ –±—É–¥—É—Ç –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω—ã (—ç—Ç–æ –∑–∞–π–º—ë—Ç 2‚Äì5 —Å–µ–∫—É–Ω–¥).<br><br>
      –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –±—É–¥–µ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–º üôÇ
    </div>
  </div>
</div>
<script type="module">
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  const supabaseUrl = 'https://vljgvblmzejgtzgtawhl.supabase.co'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π
  const supabaseKey = 'sb_publishable_b9fhcbsfYXhJ1L5iNYmsZg_xEfutsMZ'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π
  const stripePriceId = 'prices/price_1SylFkIJaijs47jMte2PEM6O'; // –ó–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π –∏–∑ Stripe

  window.supabase = createClient(supabaseUrl, supabaseKey);

  const elements = {
    modal: document.getElementById('modal'),
    authModal: document.getElementById('auth-modal'),
    mainBtn: document.getElementById('mainBtn'),
    refreshBtn: document.getElementById('refreshBtn'),
    subscribeBtn: document.getElementById('subscribe-btn'),
    logoutBtn: document.getElementById('logout-btn'),
    closeBtn: document.getElementById('closeBtn'),
    authClose: document.getElementById('auth-close'),
    loader: document.getElementById('loader'),
    error: document.getElementById('error'),
    category: document.getElementById('category'),
    title: document.getElementById('title'),
    photo: document.getElementById('photo'),
    ingredients: document.getElementById('ingredients'),
    steps: document.getElementById('steps'),
    time: document.getElementById('time'),
    calories: document.getElementById('calories'),
    note: document.getElementById('note'),
    welcomeModal: document.getElementById('welcome-modal'),
    welcomeClose: document.getElementById('welcome-close'),
    emailInput: document.getElementById('email'),
    passwordInput: document.getElementById('password'),
    signupBtn: document.getElementById('signup-btn'),
    signinBtn: document.getElementById('signin-btn')
  };

  let loadedRecipes = {};
  let currentCategory = null;
  let recipeIndices = {};
  let allPhotos = new Set();
  const categoryNames = {
    breakfast: "–ó–∞–≤—Ç—Ä–∞–∫",
    lunch: "–û–±–µ–¥",
    dinner: "–£–∂–∏–Ω",
    soups: "–°—É–ø—ã",
    dessert: "–î–µ—Å–µ—Ä—Ç"
  };
  const fallbackImage = 'data:image/svg+xml;utf8,<svg width="400" height="200" viewBox="0 0 400 200" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="200" fill="%23f8f1e9"/><text x="50%" y="45%" font-family="Inter" font-size="16" fill="%23997" text-anchor="middle">–§–æ—Ç–æ –±–ª—é–¥–∞</text><text x="50%" y="60%" font-family="Inter" font-size="13" fill="%23aaa" text-anchor="middle">(–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)</text></svg>';

  // –§—É–Ω–∫—Ü–∏–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
  async function signUp() {
    const email = elements.emailInput.value;
    const password = elements.passwordInput.value;
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: {
        emailRedirectTo: window.location.origin
      }
    });
    if (error) {
      elements.error.textContent = error.message;
      elements.error.style.display = 'block';
    } else {
      alert("–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.");
      closeAuthModal();
    }
  }

  async function signIn() {
    const email = elements.emailInput.value;
    const password = elements.passwordInput.value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      elements.error.textContent = error.message;
      elements.error.style.display = 'block';
    } else {
      closeAuthModal();
      await initAuth();
    }
  }

  async function logout() {
    await supabase.auth.signOut();
    location.reload();
  }

  async function getUserAndSubscription() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return null;

    const { data: profile, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user.id)
      .single();

    if (error) console.error(error);
    return { user, profile };
  }

  async function initAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
      const { profile } = await getUserAndSubscription();
      elements.mainBtn.style.display = 'block';
      elements.logoutBtn.style.display = 'block';
      if (profile?.is_subscribed) {
        elements.subscribeBtn.style.display = 'none';
        elements.mainBtn.disabled = false;
        // –ú–æ–∂–Ω–æ —Å—Ä–∞–∑—É –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç –∏–ª–∏ –ø–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
      } else {
        elements.subscribeBtn.style.display = 'block';
        elements.mainBtn.disabled = true;
        elements.error.textContent = '–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Ü–µ–ø—Ç–∞–º –æ—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É.';
        elements.error.style.display = 'block';
      }
    } else {
      elements.mainBtn.style.display = 'none';
      elements.subscribeBtn.style.display = 'none';
      elements.logoutBtn.style.display = 'none';
      openAuthModal();
    }
  }

  async function createCheckoutSession() {
    const { data: { user } } = await supabase.auth.getUser();
    const response = await fetch('/.netlify/functions/create-checkout', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        priceId: stripePriceId,
        clientReferenceId: user.id  // –ü–µ—Ä–µ–¥–∞—ë–º user.id –¥–ª—è webhook
      })
    });
    const { url } = await response.json();
    window.location.href = url;
  }

  function openAuthModal() {
    elements.authModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeAuthModal() {
    elements.authModal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function showWelcomeIfFirstTime() {
    if (!localStorage.getItem('hasSeenWelcome')) {
      elements.welcomeModal.style.display = 'flex';
      localStorage.setItem('hasSeenWelcome', 'true');
    }
  }

  function closeWelcome() {
    elements.welcomeModal.style.display = 'none';
  }

  async function loadCategoryRecipes(category) {
    if (loadedRecipes[category]) return loadedRecipes[category];
    try {
      elements.loader.style.display = 'block';
      const response = await fetch(`recipes/${category}.json`);
      if (!response.ok) throw new Error(`HTTP ${response.status} –¥–ª—è ${category}`);
      const data = await response.json();
      loadedRecipes[category] = data;
      data.forEach(r => {
        if (r.photo) {
          const filename = r.photo.split('/').pop();
          const base = filename.replace(/\.(webp|png|jpg|jpeg)$/i, '');
          allPhotos.add(`pics/${base}.webp`);
        }
      });
      elements.loader.style.display = 'none';
      return data;
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', category, err);
      elements.loader.style.display = 'none';
      elements.error.textContent = `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${categoryNames[category] || category}`;
      elements.error.style.display = 'block';
      return [];
    }
  }

  function preloadAllImages() {
    console.log(`–ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞–µ–º ${allPhotos.size} webp-–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π...`);
    allPhotos.forEach(src => {
      const img = new Image();
      img.src = src;
      img.onload = () => console.log(`–£—Å–ø–µ—à–Ω–æ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–æ: ${src}`);
      img.onerror = () => console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∏—Ç—å: ${src}`);
    });
  }

  function openModal() {
    elements.modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }

  function closeModal() {
    elements.modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  }

  function selectCategory(cat) {
    currentCategory = cat;
    closeModal();
    generateRecipe();
  }

  async function generateRecipe() {
    const { profile } = await getUserAndSubscription();
    if (!profile?.is_subscribed) {
      elements.error.textContent = '–î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ.';
      elements.error.style.display = 'block';
      return;
    }

    if (!currentCategory) return openModal();
    const recipes = await loadCategoryRecipes(currentCategory);
    if (!recipes?.length) {
      elements.error.textContent = '–†–µ—Ü–µ–ø—Ç—ã –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç';
      elements.error.style.display = 'block';
      elements.refreshBtn.style.display = 'none';
      return;
    }
    let idx = recipeIndices[currentCategory] || 0;
    recipeIndices[currentCategory] = (idx + 1) % recipes.length;
    updateUI(recipes[idx]);
    elements.refreshBtn.style.display = 'block';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function updateUI(r) {
    elements.category.textContent = categoryNames[currentCategory]?.toUpperCase() || currentCategory.toUpperCase();
    elements.title.textContent = (r.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è').trim();
    const photoEl = elements.photo;
    photoEl.classList.remove('loaded');
    photoEl.style.display = 'block';
    let photoSrc = fallbackImage;
    if (r.photo) {
      const filename = r.photo.split('/').pop();
      const base = filename.replace(/\.(webp|png|jpg|jpeg)$/i, '');
      photoSrc = `pics/${base}.webp`;
      console.log(`–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è "${r.title}": ${photoSrc}`);
    } else {
      console.log(`–ù–µ—Ç photo –≤ —Ä–µ—Ü–µ–ø—Ç–µ "${r.title}" ‚Üí fallback`);
    }
    photoEl.src = photoSrc;
    photoEl.onload = () => {
      console.log(`–£—Å–ø–µ—Ö: ${photoSrc}`);
      photoEl.classList.add('loaded');
    };
    photoEl.onerror = () => {
      console.warn(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å: ${photoSrc} ‚Üí fallback`);
      photoEl.src = fallbackImage;
    };
    elements.ingredients.innerHTML = '';
    if (Array.isArray(r.ingredients) && r.ingredients.length) {
      elements.ingredients.innerHTML = `
        <div class="section-title">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</div>
        <div class="plain-list">${r.ingredients.map(item => item.trim()).join('<br>')}</div>
      `;
    }
    elements.steps.innerHTML = '';
    if (Array.isArray(r.steps) && r.steps.length) {
      elements.steps.innerHTML = `
        <div class="section-title">–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</div>
        <div class="plain-list">${r.steps.map((step, i) => `${i + 1}. ${step.trim()}`).join('<br>')}</div>
      `;
    }
    elements.time.innerHTML = `<strong>–í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:</strong> ${r.time || '‚Äî'}`;
    elements.calories.innerHTML = `<strong>–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å:</strong> ${r.calories || '‚Äî'} –∫–∫–∞–ª`;
    if (r.note) {
      elements.note.innerHTML = `<strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong><br>${r.note.trim()}`;
      elements.note.style.display = 'block';
    } else {
      elements.note.style.display = 'none';
    }
  }

  document.addEventListener('DOMContentLoaded', async () => {
    await initAuth();  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

    elements.title.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é';
    elements.photo.src = fallbackImage;
    elements.mainBtn.onclick = () => {
      const { profile } = getUserAndSubscription();
      if (profile?.is_subscribed) {
        openModal();
      } else {
        alert('–û—Ñ–æ—Ä–º–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞.');
      }
    };
    elements.refreshBtn.onclick = generateRecipe;
    elements.subscribeBtn.onclick = createCheckoutSession;
    elements.logoutBtn.onclick = logout;
    elements.closeBtn.onclick = closeModal;
    elements.authClose.onclick = closeAuthModal;
    elements.signupBtn.onclick = signUp;
    elements.signinBtn.onclick = signIn;
    document.querySelectorAll('.choice').forEach(btn => {
      btn.onclick = () => selectCategory(btn.dataset.category);
    });
    elements.modal.onclick = e => {
      if (e.target === elements.modal) closeModal();
    };
    elements.authModal.onclick = e => {
      if (e.target === elements.authModal) closeAuthModal();
    };
    document.onkeydown = e => {
      if (e.key === 'Escape') {
        if (elements.modal.style.display === 'flex') closeModal();
        if (elements.authModal.style.display === 'flex') closeAuthModal();
      }
    };
    elements.welcomeClose.onclick = closeWelcome;
    elements.welcomeModal.onclick = e => {
      if (e.target === elements.welcomeModal) closeWelcome();
    };
    showWelcomeIfFirstTime();
    elements.refreshBtn.style.display = 'none';
    const preloadCheck = setInterval(() => {
      if (Object.keys(loadedRecipes).length > 0) {
        preloadAllImages();
        clearInterval(preloadCheck);
      }
    }, 800);
  });
</script>
</body>
</html>
