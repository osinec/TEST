<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      min-height: 100vh;
      color: #222;
      padding: 20px 12px;
    }
    .card {
      width: 100%;
      max-width: 720px;
      background: rgba(255,255,255,0.97);
      border-radius: 24px;
      padding: 28px 20px;
      box-shadow: 0 25px 60px rgba(0,0,0,0.12);
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      font-size: 26px;
      font-weight: 700;
      color: #c7903d;
      margin-bottom: 28px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      margin: 28px 0;
      justify-content: center;
    }
    button {
      font-family: inherit;
      cursor: pointer;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      transition: all .28s;
      padding: 14px 32px;
      font-size: 15px;
    }
    .main-btn {
      background: linear-gradient(135deg, #f6d365, #fda085);
      color: #222;
      min-width: 220px;
    }
    .main-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.12);
    }
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #ef6c00;
      margin-bottom: 24px;
      text-align: center;
    }
    .settings {
      background: #fffaf0;
      border-radius: 18px;
      padding: 24px;
      margin-bottom: 40px;
    }
    .meal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
    }
    .meal-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .meal-card {
      background: white;
      border-radius: 18px;
      padding: 20px;
      border: 2px solid #eee;
      transition: all 0.25s ease;
      box-shadow: 0 3px 12px rgba(0,0,0,0.05);
      cursor: pointer;
      height: 110px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .meal-card.active {
      border-color: #f4a261;
      background: #fff8e1;
      box-shadow: 0 6px 18px rgba(244,162,97,0.18);
    }
    .meal-header {
      display: flex;
      align-items: center;
      gap: 14px;
      font-size: 18px;
      font-weight: 600;
      color: #444;
    }
    .meal-icon {
      font-size: 32px;
    }
    .frequency-wrapper {
      height: 0;
      overflow: hidden;
      transition: height 0.35s ease;
    }
    .meal-item.active .frequency-wrapper {
      height: 100px;
    }
    .frequency-control {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 0 8px;
    }
    .frequency-label {
      font-size: 14px;
      color: #666;
      text-align: center;
    }
    input[type="range"] {
      width: 100%;
      height: 8px;
      background: #ffe082;
      border-radius: 4px;
      outline: none;
      -webkit-appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 24px;
      height: 24px;
      background: #ffb74d;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background: #ffb74d;
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .frequency-value {
      font-size: 16px;
      font-weight: 600;
      color: #ef6c00;
      text-align: center;
    }
    .menu-wrapper {
      overflow-x: auto;
      margin: 20px 0;
      border-radius: 18px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.07);
    }
    table {
      width: 100%;
      min-width: 640px;
      border-collapse: separate;
      border-spacing: 0;
      background: white;
      border-radius: 18px;
      overflow: hidden;
    }
    th, td {
      padding: 12px 10px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #fff8e1;
      color: #ef6c00;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
    }
    td {
      border-bottom: 1px solid #f5f5f5;
    }
    .meal-row td:first-child {
      text-align: left;
      font-weight: 600;
      background: #fffaf0;
      padding-left: 16px;
      color: #ef6c00;
    }
    .recipe-link {
      color: #c7903d;
      text-decoration: none;
      cursor: pointer;
    }
    .recipe-link:hover {
      color: #ef6c00;
      text-decoration: underline;
    }
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #777;
      font-size: 16px;
      font-style: italic;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ—Ü–µ–ø—Ç–∞ */
    .recipe-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }
    .recipe-modal-box {
      background: #fff;
      padding: 28px 24px;
      border-radius: 20px;
      width: 100%;
      max-width: 520px;
      max-height: 88vh;
      overflow-y: auto;
      position: relative;
    }
    .close-recipe {
      position: absolute;
      top: 12px; right: 16px;
      font-size: 24px;
      cursor: pointer;
      opacity: .7;
    }
    .close-recipe:hover { opacity: 1; }
    .recipe-photo {
      width: 100%;
      max-height: 260px;
      object-fit: cover;
      border-radius: 14px;
      margin: 12px 0 20px;
    }
    .recipe-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 18px;
    }
    .recipe-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #444;
      margin: 20px 0 10px;
    }
    .recipe-plain-list {
      font-size: 15px;
      line-height: 1.6;
      color: #333;
      white-space: pre-wrap;
    }
    .recipe-note {
      font-size: 14.5px;
      color: #666;
      font-style: italic;
      padding: 12px 16px;
      background: #fdfaf7;
      border-left: 4px solid #f4a261;
      border-radius: 8px;
      margin-top: 16px;
    }

    @media (max-width: 680px) {
      .card { padding: 24px 18px; }
      h1 { font-size: 24px; }
      .meal-grid { grid-template-columns: 1fr; }
      .meal-card { height: 100px; padding: 18px; }
      .meal-header { font-size: 17px; }
      .meal-icon { font-size: 30px; }
    }
  </style>
</head>
<body>

<div class="card">
  <h1>–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>

  <div class="settings">
    <div class="section-title">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –∏ —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –∏—Ö –≥–æ—Ç–æ–≤–∏—Ç—å</div>
    <div class="meal-grid">
      <div class="meal-item">
        <div class="meal-card" id="card-breakfast">
          <input type="checkbox" id="chk-breakfast" style="display:none;">
          <label for="chk-breakfast" style="cursor:pointer;display:flex;align-items:center;gap:14px;height:100%;">
            <span class="meal-icon">‚òï</span>
            <span class="meal-name">–ó–∞–≤—Ç—Ä–∞–∫</span>
          </label>
        </div>
        <div class="frequency-wrapper" id="freq-wrapper-breakfast">
          <div class="frequency-control">
            <div class="frequency-label">–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é:</div>
            <input type="range" id="freq-breakfast" min="1" max="7" value="7" step="1">
            <div class="frequency-value" id="value-breakfast">7 —Ä–∞–∑</div>
          </div>
        </div>
      </div>

      <div class="meal-item">
        <div class="meal-card" id="card-soups">
          <input type="checkbox" id="chk-soups" style="display:none;">
          <label for="chk-soups" style="cursor:pointer;display:flex;align-items:center;gap:14px;height:100%;">
            <span class="meal-icon">ü•£</span>
            <span class="meal-name">–ü–µ—Ä–≤–æ–µ</span>
          </label>
        </div>
        <div class="frequency-wrapper" id="freq-wrapper-soups">
          <div class="frequency-control">
            <div class="frequency-label">–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é:</div>
            <input type="range" id="freq-soups" min="1" max="7" value="3" step="1">
            <div class="frequency-value" id="value-soups">3 —Ä–∞–∑–∞</div>
          </div>
        </div>
      </div>

      <div class="meal-item">
        <div class="meal-card" id="card-lunch">
          <input type="checkbox" id="chk-lunch" style="display:none;">
          <label for="chk-lunch" style="cursor:pointer;display:flex;align-items:center;gap:14px;height:100%;">
            <span class="meal-icon">üç≤</span>
            <span class="meal-name">–í—Ç–æ—Ä–æ–µ</span>
          </label>
        </div>
        <div class="frequency-wrapper" id="freq-wrapper-lunch">
          <div class="frequency-control">
            <div class="frequency-label">–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é:</div>
            <input type="range" id="freq-lunch" min="1" max="7" value="4" step="1">
            <div class="frequency-value" id="value-lunch">4 —Ä–∞–∑–∞</div>
          </div>
        </div>
      </div>

      <div class="meal-item">
        <div class="meal-card" id="card-dinner">
          <input type="checkbox" id="chk-dinner" style="display:none;">
          <label for="chk-dinner" style="cursor:pointer;display:flex;align-items:center;gap:14px;height:100%;">
            <span class="meal-icon">üåô</span>
            <span class="meal-name">–£–∂–∏–Ω</span>
          </label>
        </div>
        <div class="frequency-wrapper" id="freq-wrapper-dinner">
          <div class="frequency-control">
            <div class="frequency-label">–°–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é:</div>
            <input type="range" id="freq-dinner" min="1" max="7" value="5" step="1">
            <div class="frequency-value" id="value-dinner">5 —Ä–∞–∑</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="controls">
    <button class="main-btn" id="generateBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º–µ–Ω—é</button>
    <button class="main-btn back-btn" onclick="window.location.href='index.html'">‚Üê –ù–∞–∑–∞–¥</button>
  </div>

  <div id="menuTable" style="margin-top:24px;"></div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="recipe-modal" id="recipeModal">
  <div class="recipe-modal-box">
    <div class="close-recipe" id="closeRecipeBtn">‚úï</div>
    <h2 class="recipe-title" id="recipeTitle"></h2>
    <img id="recipePhoto" class="recipe-photo" alt="–§–æ—Ç–æ —Ä–µ—Ü–µ–ø—Ç–∞">
    <div id="recipeIngredients"></div>
    <div id="recipeSteps"></div>
    <div id="recipeTime"></div>
    <div id="recipeCalories"></div>
    <div id="recipeNote" class="recipe-note"></div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞–º–∏ –∏ —Å–ª–∞–π–¥–µ—Ä–∞–º–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('.meal-item').forEach(item => {
  const card = item.querySelector('.meal-card');
  const chk = item.querySelector('input[type="checkbox"]');
  const wrapper = item.querySelector('.frequency-wrapper');
  const slider = item.querySelector('input[type="range"]');
  const valEl = item.querySelector('.frequency-value');

  const update = () => {
    const active = chk.checked;
    card.classList.toggle('active', active);
    wrapper.style.height = active ? '100px' : '0';
  };

  chk.addEventListener('change', update);
  slider.addEventListener('input', () => {
    const v = slider.value;
    valEl.textContent = v === '1' ? '1 —Ä–∞–∑' : `${v} —Ä–∞–∑`;
  });

  update(); // –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
});

// ‚îÄ‚îÄ‚îÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ–Ω—é —Å —É—á—ë—Ç–æ–º —á–∞—Å—Ç–æ—Ç—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DAYS = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"];
const SHORT_DAYS = ["–ü–ù", "–í–¢", "–°–†", "–ß–¢", "–ü–¢", "–°–ë", "–í–°"];

const MEAL_TYPES = [
  { key: "breakfast", title: "–ó–∞–≤—Ç—Ä–∞–∫", file: "breakfast" },
  { key: "soups", title: "–ü–µ—Ä–≤–æ–µ", file: "soups" },
  { key: "lunch", title: "–í—Ç–æ—Ä–æ–µ", file: "lunch" },
  { key: "dinner", title: "–£–∂–∏–Ω", file: "dinner" }
];

let loadedRecipes = {};
const fallbackImage = 'data:image/svg+xml;utf8,<svg width="400" height="200" viewBox="0 0 400 200" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="200" fill="%23f0f0f0"/><text x="50%" y="50%" font-family="Inter" font-size="14" fill="%23888" text-anchor="middle" dy=".3em">–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</text></svg>';

async function loadCategory(file) {
  if (loadedRecipes[file]) return loadedRecipes[file];
  try {
    document.getElementById("loader").style.display = "block";
    const res = await fetch(`recipes/${file}.json`);
    if (!res.ok) throw new Error();
    const data = await res.json();
    loadedRecipes[file] = data;
    return data;
  } catch (err) {
    console.error(err);
    return [];
  } finally {
    document.getElementById("loader").style.display = "none";
  }
}

async function preloadNeededCategories() {
  const active = MEAL_TYPES.filter(m => document.getElementById(`chk-${m.key}`).checked);
  for (const meal of active) await loadCategory(meal.file);
}

function getActiveMealTypes() {
  return MEAL_TYPES.filter(m => document.getElementById(`chk-${m.key}`).checked);
}

function generateMenu() {
  const menu = {};
  const activeMeals = getActiveMealTypes();

  if (activeMeals.length === 0) {
    document.getElementById("menuTable").innerHTML = '<div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏—ë–º –ø–∏—â–∏</div>';
    return;
  }

  // –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å–∞ (—á–∞—Å—Ç–æ—Ç—É) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏—ë–º–∞
  const weights = {};
  activeMeals.forEach(meal => {
    const slider = document.getElementById(`freq-${meal.key}`);
    weights[meal.key] = parseInt(slider.value) || 1;
  });

  DAYS.forEach(day => {
    menu[day] = {};
    activeMeals.forEach(meal => {
      const recipes = loadedRecipes[meal.file] || [];
      if (recipes.length === 0) {
        menu[day][meal.key] = "‚Äî";
        return;
      }

      // –ß–µ–º –≤—ã—à–µ –≤–µ—Å ‚Äî —Ç–µ–º –±–æ–ª—å—à–µ —à–∞–Ω—Å –≤—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç –ø—Ä–∏—ë–º –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å
      const totalWeight = Object.values(weights).reduce((a, b) => a + b, 0);
      let rand = Math.random() * totalWeight;
      let selectedMeal = null;

      for (const m of activeMeals) {
        rand -= weights[m.key];
        if (rand <= 0) {
          selectedMeal = m;
          break;
        }
      }

      // –ï—Å–ª–∏ –¥–µ–Ω—å —Å–æ–≤–ø–∞–ª —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø—Ä–∏—ë–º–æ–º ‚Äî –≤—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç
      if (selectedMeal && selectedMeal.key === meal.key) {
        const idx = Math.floor(Math.random() * recipes.length);
        menu[day][meal.key] = recipes[idx].title.trim() || "‚Äî";
      } else {
        menu[day][meal.key] = "‚Äî";
      }
    });
  });

  localStorage.setItem("weeklyMenu", JSON.stringify(menu));
  renderMenu(menu, activeMeals);
}

function renderMenu(menu, activeMeals) {
  let html = '<table><thead><tr><th></th>';
  SHORT_DAYS.forEach(d => html += `<th>${d}</th>`);
  html += '</tr></thead><tbody>';

  activeMeals.forEach(meal => {
    html += `<tr><td class="meal-row">${meal.title}</td>`;
    DAYS.forEach(day => {
      const title = menu[day]?.[meal.key] || "‚Äî";
      html += `<td><span class="recipe-link" data-title="${title}" data-meal="${meal.key}">${title}</span></td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById("menuTable").innerHTML = html;

  document.querySelectorAll('.recipe-link').forEach(link => {
    link.addEventListener('click', (e) => {
      const title = e.target.dataset.title.trim();
      const mealKey = e.target.dataset.meal;
      if (title !== "‚Äî") showRecipe(title, mealKey);
    });
  });
}

function showRecipe(title, mealKey) {
  const recipes = loadedRecipes[mealKey] || [];
  const recipe = recipes.find(r => (r.title || '').trim() === title);

  if (!recipe) return alert('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');

  document.getElementById('recipeTitle').textContent = recipe.title;

  const photo = document.getElementById('recipePhoto');
  let src = fallbackImage;
  if (recipe.photo) {
    const name = recipe.photo.split('/').pop().replace(/\.(webp|png|jpg|jpeg)$/i, '');
    src = `pics/${name}.webp`;
  }
  photo.src = src;
  photo.onload = () => photo.style.opacity = 1;
  photo.onerror = () => photo.src = fallbackImage;

  document.getElementById('recipeIngredients').innerHTML = recipe.ingredients?.length
    ? `<div class="recipe-section-title">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</div><div class="recipe-plain-list">${recipe.ingredients.join('<br>')}</div>` : '';

  document.getElementById('recipeSteps').innerHTML = recipe.steps?.length
    ? `<div class="recipe-section-title">–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</div><div class="recipe-plain-list">${recipe.steps.map((s,i)=>`${i+1}. ${s}`).join('<br>')}</div>` : '';

  document.getElementById('recipeTime').textContent = `–í—Ä–µ–º—è: ${recipe.time || '‚Äî'}`;
  document.getElementById('recipeCalories').textContent = `–ö–∞–ª–æ—Ä–∏–∏: ${recipe.calories || '‚Äî'} –∫–∫–∞–ª`;

  const note = document.getElementById('recipeNote');
  if (recipe.note) {
    note.innerHTML = `<strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong><br>${recipe.note}`;
    note.style.display = 'block';
  } else note.style.display = 'none';

  document.getElementById('recipeModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

document.getElementById('closeRecipeBtn').onclick = () => {
  document.getElementById('recipeModal').style.display = 'none';
  document.body.style.overflow = '';
};

document.getElementById('recipeModal').onclick = e => {
  if (e.target === document.getElementById('recipeModal')) {
    document.getElementById('recipeModal').style.display = 'none';
    document.body.style.overflow = '';
  }
};

document.getElementById('generateBtn').onclick = async () => {
  await preloadNeededCategories();
  generateMenu();
};
</script>
</body>
</html>
