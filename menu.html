<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      min-height: 100vh;
      color: #222;
      padding: 30px 16px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .card {
      width: 100%;
      max-width: 720px;
      background: rgba(255,255,255,.96);
      border-radius: 26px;
      padding: 32px 24px;
      box-shadow: 0 30px 70px rgba(0,0,0,.18);
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      font-size: 26px;
      font-weight: 700;
      color: #c7903d;
      margin-bottom: 32px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 32px;
      justify-content: center;
    }
    button {
      font-family: 'Inter', sans-serif;
      cursor: pointer;
      border: none;
      border-radius: 40px;
      font-weight: 600;
      transition: all .3s;
      padding: 16px 32px;
      font-size: 16px;
    }
    .main-btn {
      background: linear-gradient(135deg, #f6d365, #fda085);
      color: #222;
      min-width: 220px;
    }
    .main-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0,0,0,.15);
    }
    .back-btn {
      background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
      color: #222;
      min-width: 220px;
    }
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin: 24px 0 16px;
    }
    .settings {
      background: #fdfaf7;
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 48px;
    }
    .meal-choices {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    .meal-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: #ffffff;
      border-radius: 16px;
      border: 2px solid #eee;
      cursor: pointer;
      transition: all 0.25s ease;
      user-select: none;
      font-size: 15px;
      font-weight: 500;
      color: #444;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .meal-option:hover {
      border-color: #f4a261;
      box-shadow: 0 6px 16px rgba(244,162,97,0.15);
      transform: translateY(-1px);
    }
    .meal-option.selected {
      background: linear-gradient(135deg, #fffaf0, #ffe8d1);
      border-color: #f4a261;
      color: #c7903d;
      font-weight: 600;
      box-shadow: 0 6px 18px rgba(244,162,97,0.2);
    }
    .meal-option input[type="checkbox"] {
      display: none;
    }
    .meal-icon {
      font-size: 22px;
      line-height: 1;
    }
    .menu-wrapper {
      overflow-x: auto;
      margin: 20px 0;
    }
    table {
      width: 100%;
      min-width: 600px;
      border-collapse: collapse;
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 16px rgba(0,0,0,0.08);
    }
    th, td {
      padding: 12px 10px;
      text-align: center;
      border-bottom: 1px solid #eee;
      font-size: 15px;
    }
    th {
      background: #fdfaf7;
      color: #c7903d;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 13px;
    }
    .meal-row td:first-child {
      text-align: left;
      font-weight: 600;
      color: #444;
      background: #f9f9f9;
      padding-left: 16px;
    }
    .recipe-link {
      color: #c7903d;
      text-decoration: none;
      cursor: pointer;
      font-weight: 500;
      transition: color 0.2s;
    }
    .recipe-link:hover {
      color: #ef6c00;
      text-decoration: underline;
    }
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: #777;
      font-size: 16px;
      font-style: italic;
    }

    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ—Ü–µ–ø—Ç–∞ */
    .recipe-modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(6px);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }
    .recipe-modal-box {
      background: #fff;
      padding: 32px 28px;
      border-radius: 22px;
      width: 100%;
      max-width: 540px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      text-align: center;
    }
    .close-recipe {
      position: absolute;
      top: 12px; right: 14px;
      font-size: 26px;
      cursor: pointer;
      opacity: .6;
      transition: opacity 0.2s;
    }
    .close-recipe:hover { opacity: 1; }
    .recipe-photo {
      width: 100%;
      max-height: 280px;
      object-fit: cover;
      border-radius: 16px;
      margin: 12px 0 20px;
      background: #f0f0f0 url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23e0e0e0"/></svg>') center/cover no-repeat;
    }
    .recipe-title {
      font-size: 24px;
      font-weight: 700;
      margin: 15px 0 20px;
      line-height: 1.3;
    }
    .recipe-section-title {
      text-align: left;
      font-size: 17px;
      font-weight: 600;
      color: #333;
      margin: 24px 0 12px;
    }
    .recipe-plain-list {
      text-align: left;
      font-size: 16px;
      line-height: 1.65;
      color: #333;
      margin: 0 0 24px 0;
      white-space: pre-wrap;
    }
    .recipe-note {
      text-align: left;
      margin-top: 20px;
      font-size: 15.5px;
      color: #555;
      font-style: italic;
      padding: 14px 16px;
      background: #fdfaf7;
      border-left: 4px solid #f4a261;
      border-radius: 8px;
      line-height: 1.6;
    }

    @media (max-width: 600px) {
      .card { padding: 24px 20px; }
      h1 { font-size: 24px; }
      .controls { flex-direction: column; }
      button { width: 100%; min-width: auto; }
      .meal-choices { grid-template-columns: 1fr; }
      th, td { font-size: 14px; padding: 10px 8px; }
    }
  </style>
</head>
<body>

<div class="card">
  <h1>–ú–µ–Ω—é –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>

  <div class="settings">
    <div class="section-title">–ü—Ä–∏—ë–º—ã –ø–∏—â–∏</div>
    <div class="meal-choices">
      <label class="meal-option" id="label-breakfast">
        <input type="checkbox" id="chk-breakfast">
        <span class="meal-icon">‚òï</span> –ó–∞–≤—Ç—Ä–∞–∫
      </label>

      <label class="meal-option" id="label-soups">
        <input type="checkbox" id="chk-soups">
        <span class="meal-icon">ü•£</span> –ü–µ—Ä–≤–æ–µ
      </label>

      <label class="meal-option" id="label-lunch">
        <input type="checkbox" id="chk-lunch">
        <span class="meal-icon">üç≤</span> –í—Ç–æ—Ä–æ–µ
      </label>

      <label class="meal-option" id="label-dinner">
        <input type="checkbox" id="chk-dinner">
        <span class="meal-icon">üåô</span> –£–∂–∏–Ω
      </label>
    </div>
  </div>

  <div class="controls">
    <button class="main-btn" id="generateBtn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é</button>
    <button class="main-btn back-btn" onclick="window.location.href='index.html'">‚Üê –ù–∞–∑–∞–¥ –∫ —Ä–µ—Ü–µ–ø—Ç–∞–º</button>
  </div>

  <div id="loader" class="loader" style="display:none">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤...</div>
  <div id="error" class="error" style="display:none"></div>

  <div class="menu-wrapper">
    <div id="menuTable"></div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ—Ü–µ–ø—Ç–∞ -->
<div class="recipe-modal" id="recipeModal">
  <div class="recipe-modal-box">
    <div class="close-recipe" id="closeRecipeBtn">‚úï</div>
    <h2 class="recipe-title" id="recipeTitle"></h2>
    <img id="recipePhoto" class="recipe-photo" alt="–§–æ—Ç–æ —Ä–µ—Ü–µ–ø—Ç–∞" loading="lazy" decoding="async">
    <div id="recipeIngredients"></div>
    <div id="recipeSteps"></div>
    <div id="recipeTime"></div>
    <div id="recipeCalories"></div>
    <div id="recipeNote" class="recipe-note"></div>
  </div>
</div>

<script>
// –û–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ–∫–±–æ–∫—Å–æ–≤
document.querySelectorAll('.meal-option').forEach(label => {
  const checkbox = label.querySelector('input[type="checkbox"]');
  const update = () => {
    label.classList.toggle('selected', checkbox.checked);
  };
  checkbox.addEventListener('change', update);
  update(); // –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
});

const DAYS = ["–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫", "–í—Ç–æ—Ä–Ω–∏–∫", "–°—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä–≥", "–ü—è—Ç–Ω–∏—Ü–∞", "–°—É–±–±–æ—Ç–∞", "–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"];
const SHORT_DAYS = ["–ü–ù", "–í–¢", "–°–†", "–ß–¢", "–ü–¢", "–°–ë", "–í–°"];

const MEAL_TYPES = [
  { key: "breakfast", title: "–ó–∞–≤—Ç—Ä–∞–∫", file: "breakfast" },
  { key: "soups",     title: "–ü–µ—Ä–≤–æ–µ",  file: "soups"     },
  { key: "lunch",     title: "–í—Ç–æ—Ä–æ–µ",  file: "lunch"     },
  { key: "dinner",    title: "–£–∂–∏–Ω",    file: "dinner"    }
];

let loadedRecipes = {};
const fallbackImage = 'data:image/svg+xml;utf8,<svg width="400" height="200" viewBox="0 0 400 200" fill="none" xmlns="http://www.w3.org/2000/svg"><rect width="400" height="200" fill="%23f0f0f0"/><text x="50%" y="50%" font-family="Inter" font-size="14" fill="%23888" text-anchor="middle" dy=".3em">–§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</text></svg>';

async function loadCategory(file) {
  if (loadedRecipes[file]) return loadedRecipes[file];
  try {
    document.getElementById("loader").style.display = "block";
    const res = await fetch(`recipes/${file}.json`);
    if (!res.ok) throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ${file}.json`);
    const data = await res.json();
    loadedRecipes[file] = data;
    return data;
  } catch (err) {
    console.error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ${file}:`, err);
    document.getElementById("error").textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã";
    document.getElementById("error").style.display = "block";
    return [];
  } finally {
    document.getElementById("loader").style.display = "none";
  }
}

async function preloadNeededCategories() {
  const active = MEAL_TYPES.filter(m => document.getElementById(`chk-${m.key}`).checked);
  for (const meal of active) {
    await loadCategory(meal.file);
  }
}

function getActiveMealTypes() {
  return MEAL_TYPES.filter(m => document.getElementById(`chk-${m.key}`).checked);
}

// –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–º–µ—à–∏–≤–∞–Ω–∏—è –º–∞—Å—Å–∏–≤–∞ (Fisher-Yates)
function shuffle(array) {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
}

function generateMenu() {
  const menu = {};
  const activeMeals = getActiveMealTypes();

  if (activeMeals.length === 0) {
    document.getElementById("menuTable").innerHTML = '<div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–∏—ë–º –ø–∏—â–∏</div>';
    return;
  }

  // –î–ª—è –∫–∞–∂–¥–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –≥–æ—Ç–æ–≤–∏–º –ø–µ—Ä–µ–º–µ—à–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤
  const categoryShuffled = {};
  activeMeals.forEach(meal => {
    const recipes = loadedRecipes[meal.file] || [];
    if (recipes.length > 0) {
      categoryShuffled[meal.key] = shuffle(recipes);
    } else {
      categoryShuffled[meal.key] = [];
    }
  });

  DAYS.forEach((day, dayIndex) => {
    menu[day] = {};
    activeMeals.forEach(meal => {
      const shuffled = categoryShuffled[meal.key];
      if (shuffled.length > 0) {
        // –ë–µ—Ä—ë–º —Ä–µ—Ü–µ–ø—Ç –ø–æ –∏–Ω–¥–µ–∫—Å—É –¥–Ω—è (—Ü–∏–∫–ª–∏—á–µ—Å–∫–∏, –µ—Å–ª–∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –º–µ–Ω—å—à–µ 7)
        const idx = dayIndex % shuffled.length;
        menu[day][meal.key] = shuffled[idx].title || "‚Äî";
      } else {
        menu[day][meal.key] = "‚Äî";
      }
    });
  });

  localStorage.setItem("weeklyMenu", JSON.stringify(menu));
  renderMenu(menu, activeMeals);
}

function renderMenu(menu, activeMeals) {
  let html = '<table><thead><tr><th></th>';
  SHORT_DAYS.forEach(d => html += `<th>${d}</th>`);
  html += '</tr></thead><tbody>';

  activeMeals.forEach(meal => {
    html += `<tr><td class="meal-row">${meal.title}</td>`;
    DAYS.forEach(day => {
      const title = menu[day]?.[meal.key] || "‚Äî";
      html += `<td><span class="recipe-link" data-title="${title.replace(/"/g,'&quot;')}" data-meal="${meal.key}">${title}</span></td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  document.getElementById("menuTable").innerHTML = html;

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º –±–ª—é–¥
  document.querySelectorAll('.recipe-link').forEach(link => {
    link.addEventListener('click', (e) => {
      const title = e.target.dataset.title;
      const mealKey = e.target.dataset.meal;
      if (title && title !== "‚Äî") {
        showRecipe(title, mealKey);
      }
    });
  });
}

function showRecipe(title, mealKey) {
  const recipes = loadedRecipes[mealKey] || [];
  const recipe = recipes.find(r => r.title && r.title.trim() === title.trim());

  if (!recipe) {
    alert('–†–µ—Ü–µ–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
    return;
  }

  document.getElementById('recipeTitle').textContent = recipe.title || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

  // –§–æ—Ç–æ
  const photoEl = document.getElementById('recipePhoto');
  let photoSrc = fallbackImage;

  if (recipe.photo) {
    const base = recipe.photo.replace(/\.(webp|png|jpg|jpeg)$/i, '');
    const tryWebp = `pics/${base}.webp`;
    photoEl.src = tryWebp;
    photoEl.onerror = () => {
      console.log(`webp –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Üí fallback`);
      photoEl.src = fallbackImage;
    };
  } else {
    photoEl.src = fallbackImage;
  }

  // –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã
  const ing = document.getElementById('recipeIngredients');
  ing.innerHTML = recipe.ingredients?.length
    ? `<div class="recipe-section-title">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</div><div class="recipe-plain-list">${recipe.ingredients.map(i => i.trim()).join('<br>')}</div>`
    : '';

  // –®–∞–≥–∏
  const steps = document.getElementById('recipeSteps');
  steps.innerHTML = recipe.steps?.length
    ? `<div class="recipe-section-title">–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</div><div class="recipe-plain-list">${recipe.steps.map((s,i) => `${i+1}. ${s.trim()}`).join('<br>')}</div>`
    : '';

  // –í—Ä–µ–º—è –∏ –∫–∞–ª–æ—Ä–∏–∏
  document.getElementById('recipeTime').innerHTML = `<strong>–í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è:</strong> ${recipe.time || '‚Äî'}`;
  document.getElementById('recipeCalories').innerHTML = `<strong>–ö–∞–ª–æ—Ä–∏–π–Ω–æ—Å—Ç—å:</strong> ${recipe.calories || '‚Äî'} –∫–∫–∞–ª`;

  // –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ
  const noteEl = document.getElementById('recipeNote');
  if (recipe.note) {
    noteEl.innerHTML = `<strong>–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:</strong><br>${recipe.note.trim()}`;
    noteEl.style.display = 'block';
  } else {
    noteEl.style.display = 'none';
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
  document.getElementById('recipeModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeRecipeModal() {
  document.getElementById('recipeModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function loadSavedMenu() {
  try {
    return JSON.parse(localStorage.getItem("weeklyMenu"));
  } catch {
    return null;
  }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener("DOMContentLoaded", async () => {
  const savedMenu = loadSavedMenu();
  const activeMeals = getActiveMealTypes();

  if (savedMenu && activeMeals.length > 0) {
    renderMenu(savedMenu, activeMeals);
  } else {
    document.getElementById("menuTable").innerHTML = '<div class="empty">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—ë–º—ã –ø–∏—â–∏ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å –º–µ–Ω—é¬ª</div>';
  }

  document.getElementById("generateBtn").onclick = async () => {
    await preloadNeededCategories();
    generateMenu();
  };

  document.getElementById("closeRecipeBtn").onclick = closeRecipeModal;
  document.getElementById("recipeModal").onclick = e => {
    if (e.target === document.getElementById("recipeModal")) closeRecipeModal();
  };

  MEAL_TYPES.forEach(m => {
    document.getElementById(`chk-${m.key}`).onchange = () => {
      const saved = loadSavedMenu();
      if (saved) renderMenu(saved, getActiveMealTypes());
    };
  });
});
</script>
</body>
</html>
