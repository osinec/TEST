<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Умные рецепты по кругу</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.1/dist/pocketbase.umd.min.js"></script>
  <style>
    /* Стили из вашего оригинала */
    :root {
      --primary: #ff6b6b;
      --bg: #f9f9f9;
      --text: #2d3436;
      --success: #27ae60;
      --error: #eb4d4b;
      --gray: #b2bec3;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    .container { width: 100%; max-width: 600px; }
    
    .ingredients-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
      gap: 10px; margin-bottom: 20px;
    }

    .ingredient-item {
      background: white; border: 2px solid #eee; border-radius: 12px;
      padding: 12px 8px; text-align: center; cursor: pointer; transition: 0.2s;
    }

    .ingredient-item input { display: none; }
    .ingredient-item:has(input:checked) {
      border-color: var(--primary); background-color: #fff5f5;
    }

    /* Кнопки */
    .actions { display: flex; gap: 10px; margin-bottom: 20px; }
    button { flex: 1; padding: 15px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; }
    #findBtn { background: var(--primary); color: white; }
    #findBtn:disabled { background: var(--gray); }
    #refreshBtn { background: #6c5ce7; color: white; display: none; } /* Кнопка обновить */

    /* Карточки */
    .recipe-card {
      background: white; border-radius: 20px; overflow: hidden;
      margin-top: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05);
    }
    .recipe-card img { width: 100%; height: 200px; object-fit: cover; }
    .recipe-content { padding: 20px; }
    
    .ing-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
    .badge { padding: 5px 10px; border-radius: 8px; font-size: 12px; }
    .have { background: #e3fcef; color: var(--success); }
    .missing-main { background: #ffe3e3; color: var(--error); border: 1px solid #ffcccc; }
    .missing-main::after { content: " (замени!)"; font-size: 10px; }
    .missing-extra { background: #f1f2f6; color: var(--gray); text-decoration: line-through; }
  </style>
</head>
<body>

<div class="container">
  <h1>Выбери продукты</h1>
  <div class="ingredients-grid" id="ingredientsList"></div>

  <div class="actions">
    <button id="findBtn" disabled>Подобрать рецепт</button>
    <button id="refreshBtn">Показать другой</button>
  </div>

  <div id="results"></div>
</div>

<script>
  const pb = new PocketBase('https://ВАШ-POCKETBASE-URL'); // Замените на ваш URL
  
  const CATALOG = [
    { id: 'eggs', name: 'Яйца' }, { id: 'mushrooms', name: 'Грибы' },
    { id: 'chicken', name: 'Курица' }, { id: 'cheese', name: 'Сыр' },
    { id: 'pasta', name: 'Паста' }, { id: 'tomato', name: 'Помидоры' },
    { id: 'lavash', name: 'Лаваш' }, { id: 'milk', name: 'Молоко/Сливки' }
  ];

  let currentMatchingRecipes = [];
  let currentIndex = 0;
  const selected = new Set();

  const listEl = document.getElementById('ingredientsList');
  const resultsEl = document.getElementById('results');
  const findBtn = document.getElementById('findBtn');
  const refreshBtn = document.getElementById('refreshBtn');

  // Отрисовка ингредиентов
  function init() {
    listEl.innerHTML = CATALOG.map(ing => `
      <label class="ingredient-item">
        <input type="checkbox" value="${ing.id}">
        <span>${ing.name}</span>
      </label>
    `).join('');

    document.querySelectorAll('input').forEach(input => {
      input.onchange = (e) => {
        if (e.target.checked) selected.add(e.target.value);
        else selected.delete(e.target.value);
        findBtn.disabled = selected.size === 0;
        refreshBtn.style.display = 'none'; // Скрываем "Обновить", если изменили выбор
      };
    });
  }

  // Расчет совпадения
  function calculateScore(recipe) {
    const mains = recipe.ingredients.filter(i => i.isMain);
    const matches = mains.filter(i => selected.has(i.id)).length;
    return Math.round((matches / mains.length) * 100);
  }

  // Отрисовка ОДНОГО рецепта
  function renderRecipe(recipe) {
    const ingHTML = recipe.ingredients.map(ing => {
      const has = selected.has(ing.id);
      let cls = has ? 'have' : (ing.isMain ? 'missing-main' : 'missing-extra');
      return `<span class="badge ${cls}">${ing.name}</span>`;
    }).join('');

    resultsEl.innerHTML = `
      <div class="recipe-card">
        <img src="${recipe.photo}">
        <div class="recipe-content">
          <small>Совпадение: ${recipe.score}%</small>
          <h3>${recipe.title}</h3>
          <div class="ing-list">${ingHTML}</div>
        </div>
      </div>
    `;
  }

  findBtn.onclick = async () => {
    // В реальности: fetch('all_recipes.json')
    // Для теста используем массив из предыдущего сообщения
    const data = await fetch('recipes.json').then(r => r.json()); 

    currentMatchingRecipes = data
      .map(r => ({ ...r, score: calculateScore(r) }))
      .filter(r => r.score >= 70)
      .sort(() => Math.random() - 0.5); // Случайный порядок

    if (currentMatchingRecipes.length > 0) {
      currentIndex = 0;
      renderRecipe(currentMatchingRecipes[currentIndex]);
      if (currentMatchingRecipes.length > 1) refreshBtn.style.display = 'block';
    } else {
      resultsEl.innerHTML = '<p>Нет рецептов с совпадением 80% основных продуктов.</p>';
    }
  };

  refreshBtn.onclick = () => {
    currentIndex = (currentIndex + 1) % currentMatchingRecipes.length; // Идем по кругу
    renderRecipe(currentMatchingRecipes[currentIndex]);
  };

  init();
</script>
</body>
</html>
