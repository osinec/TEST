<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/pocketbase@0.21.1/dist/pocketbase.umd.min.js"></script>
  <style>
    /* –í–ê–® –û–†–ò–ì–ò–ù–ê–õ–¨–ù–´–ô –°–¢–ò–õ–¨ */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: linear-gradient(135deg, #ffecd2, #fcb69f);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      color: #222;
      padding: 30px 16px;
    }
    .card {
      width: 100%;
      max-width: 540px;
      background: rgba(255,255,255,.96);
      border-radius: 26px;
      padding: 32px 28px;
      box-shadow: 0 30px 70px rgba(0,0,0,.18);
    }
    h1 {
      font-size: 26px;
      font-weight: 700;
      text-align: center;
      margin: 0 0 28px;
      color: #d35400;
    }
    .ingredients-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(148px, 1fr));
      gap: 10px 12px;
      margin-bottom: 20px;
    }
    .ingredient-item {
      display: flex; align-items: center; gap: 10px; padding: 12px 14px;
      background: #fdfaf7; border: 1px solid #f4d3b5; border-radius: 14px;
      cursor: pointer; transition: all 0.22s;
    }
    .ingredient-item:has(input:checked) {
      background: #fff8f2; border-color: #f4a261;
    }
    .ingredient-item input { width: 18px; height: 18px; accent-color: #f4a261; }
    
    .main-btn {
      padding: 18px 32px; background: linear-gradient(135deg, #f6d365, #fda085);
      font-size: 17px; color: #222; width: 100%; border-radius: 40px; font-weight: 600;
      margin: 16px 0; border: none; cursor: pointer;
    }
    .secondary-btn {
      padding: 14px 24px; background: linear-gradient(135deg, #a0d8ef, #b8e0f8);
      color: #222; width: 100%; border-radius: 40px; border: none; margin-bottom: 10px; cursor: pointer;
    }
    .refresh-btn {
      padding: 16px; background: linear-gradient(135deg, #4caf50, #66bb6a);
      color: white; width: 100%; border-radius: 40px; border: none; font-weight: 700; cursor: pointer;
      display: none; margin-top: 10px;
    }

    /* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –ò–ù–ì–†–ï–î–ò–ï–ù–¢–û–í –í –ö–ê–†–¢–û–ß–ö–ï */
    .ing-tag { padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 4px; display: inline-block; margin-bottom: 4px; }
    .ing-tag.have { background: #e3fcef; color: #27ae60; font-weight: 600; }
    .ing-tag.missing-main { background: #ffe3e3; color: #eb4d4b; border: 1px solid #ffcccc; }
    .ing-tag.missing-main::after { content: " (–∑–∞–º–µ–Ω–∏—Ç—å?)"; font-size: 10px; opacity: 0.7; }
    .ing-tag.missing-extra { background: #f1f2f6; color: #b2bec3; text-decoration: line-through; }
    
    .recipe-card {
      background: #fffef9; border-radius: 16px; padding: 20px; margin-top: 24px;
      border: 1px solid #f0e8e0; box-shadow: 0 6px 16px rgba(0,0,0,0.07);
    }
    .recipe-title { font-size: 21px; font-weight: 700; color: #c7903d; margin-bottom: 10px; }
    .match-percent { font-size: 12px; color: #d35400; font-weight: 600; float: right; }
  </style>
</head>
<body>

<div class="card">
  <button class="secondary-btn" onclick="window.location.href='index.html'">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
  <h1>–ß—Ç–æ –µ—Å—Ç—å –¥–æ–º–∞?</h1>

  <div class="ingredients-grid" id="ingredientsList"></div>
  
  <button class="main-btn" id="findBtn" disabled>–ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç</button>
  <button class="refresh-btn" id="refreshBtn">–ü–æ–∫–∞–∑–∞—Ç—å –¥—Ä—É–≥–æ–π –≤–∞—Ä–∏–∞–Ω—Ç</button>
  <button class="secondary-btn" id="clearBtn">–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë</button>

  <div id="results"></div>
</div>

<script>
  // –¢–æ—Ç –∂–µ –∫–∞—Ç–∞–ª–æ–≥ ID, —á—Ç–æ –∏ –≤ JSON
  const POPULAR_INGREDIENTS = [
    {id: "eggs", name: "–Ø–π—Ü–∞"}, {id: "milk", name: "–ú–æ–ª–æ–∫–æ"}, {id: "mushrooms", name: "–ì—Ä–∏–±—ã"},
    {id: "chicken", name: "–ö—É—Ä–∏—Ü–∞"}, {id: "cheese", name: "–°—ã—Ä"}, {id: "tomato", name: "–ü–æ–º–∏–¥–æ—Ä—ã"},
    {id: "pasta", name: "–ú–∞–∫–∞—Ä–æ–Ω—ã"}, {id: "oil_veg", name: "–†–∞—Å—Ç. –º–∞—Å–ª–æ"}, {id: "salt", name: "–°–æ–ª—å"}
  ];

  let selected = new Set();
  let foundRecipes = [];
  let currentIndex = 0;

  const listEl = document.getElementById('ingredientsList');
  const findBtn = document.getElementById('findBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const resultsEl = document.getElementById('results');

  // 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –≤—ã–±–æ—Ä–∞
  function renderCatalog() {
    listEl.innerHTML = POPULAR_INGREDIENTS.map(ing => `
      <label class="ingredient-item">
        <input type="checkbox" value="${ing.id}" onchange="toggleIng('${ing.id}')">
        <span>${ing.name}</span>
      </label>
    `).join('');
  }

  function toggleIng(id) {
    if (selected.has(id)) selected.delete(id);
    else selected.add(id);
    findBtn.disabled = selected.size === 0;
    refreshBtn.style.display = 'none';
  }

  // 2. –õ–æ–≥–∏–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
  function getMatchData(recipe) {
    const mainIngs = recipe.ingredients.filter(i => i.isMain);
    const matchedCount = mainIngs.filter(i => selected.has(i.id)).length;
    const percent = Math.round((matchedCount / mainIngs.length) * 100);
    return { percent, isFit: percent >= 80 };
  }

  // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ä—Ç–æ—á–∫–∏
  function renderSingleRecipe(recipe) {
    const ingsHtml = recipe.ingredients.map(ing => {
      const has = selected.has(ing.id);
      let cls = has ? 'have' : (ing.isMain ? 'missing-main' : 'missing-extra');
      return `<span class="ing-tag ${cls}">${ing.name}</span>`;
    }).join('');

    resultsEl.innerHTML = `
      <div class="recipe-card">
        <div class="match-percent">${recipe.matchPercent}% —Å–æ–≤–ø–∞–ª–æ</div>
        <div class="recipe-title">${recipe.title}</div>
        <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
          ‚è± ${recipe.time} –º–∏–Ω ‚Ä¢ üî• ${recipe.calories} –∫–∫–∞–ª
        </div>
        <div class="plain-list"><strong>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã:</strong><br>${ingsHtml}</div>
        <div class="plain-list" style="margin-top:15px;">
          <strong>–ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ:</strong><br>
          ${recipe.steps.map((s, i) => `${i+1}. ${s}`).join('<br>')}
        </div>
      </div>
    `;
  }

  findBtn.onclick = async () => {
    // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ: const data = await pb.collection('recipes').getFullList();
    // –ó–¥–µ—Å—å –∏–º–∏—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É JSON
    const data = await fetch('recipes.json').then(r => r.json());
    
    foundRecipes = data
      .map(r => {
        const m = getMatchData(r);
        return { ...r, matchPercent: m.percent, isFit: m.isFit };
      })
      .filter(r => r.isFit)
      .sort(() => Math.random() - 0.5); // –†–∞–Ω–¥–æ–º–∏–º —Å–ø–∏—Å–æ–∫

    if (foundRecipes.length > 0) {
      currentIndex = 0;
      renderSingleRecipe(foundRecipes[currentIndex]);
      if (foundRecipes.length > 1) refreshBtn.style.display = 'block';
    } else {
      resultsEl.innerHTML = '<div class="no-results">–ù–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –Ω–∞ 80%. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –±–æ–ª—å—à–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</div>';
    }
  };

  refreshBtn.onclick = () => {
    currentIndex = (currentIndex + 1) % foundRecipes.length;
    renderSingleRecipe(foundRecipes[currentIndex]);
  };

  document.getElementById('clearBtn').onclick = () => location.reload();

  renderCatalog();
</script>
</body>
</html>
